'use strict';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}var SoulPatch=function(){function SoulPatch(){var _this=this;_classCallCheck(this,SoulPatch);var links=Array.from(document.querySelectorAll('a[sp-href]'));this.container=document.querySelector('[sp-container]');this._classDone();links.forEach(function(link){link.addEventListener('click',function(evt){evt.preventDefault();_this.go(evt.target.getAttribute('sp-href'))})});this._spStartEvt=new Event('spStart');this._spEndEvt=new Event('spEnt')}_createClass(SoulPatch,[{key:'go',value:function go(url){// TODO: Controllo se ho premuto lo stesso URL
window.history.pushState(null,null,url);this._onChanged()}},{key:'_classDone',value:function _classDone(){this.container.classList.remove('loading');this.container.classList.add('done')}},{key:'_classLoading',value:function _classLoading(){this.container.classList.remove('done');this.container.classList.add('loading')}},{key:'_onChanged',value:function _onChanged(){var _this2=this;var path=window.location.href;if(this._animating){return}this._animating=true;var outViewPromise=Promise.resolve();if(this.container){outViewPromise=this._outView()}outViewPromise.then(function(){_this2._animating=false}).then(function(){return _this2._inView(path)})}},{key:'_outView',value:function _outView(){var _this3=this;return new Promise(function(resolve){var onTransitionEnd=function onTransitionEnd(){_this3.container.removeEventListener('transitionend',onTransitionEnd);resolve()};_this3._classLoading();_this3.container.addEventListener('transitionend',onTransitionEnd);_this3.container.dispatchEvent(_this3._spStartEvt)})}},{key:'_inView',value:function _inView(path){var _this4=this;this._loadView(path);return new Promise(function(resolve){var onTransitionEnd=function onTransitionEnd(){_this4.container.removeEventListener('transitionend',onTransitionEnd);resolve()};_this4._classDone();_this4.container.addEventListener('transitionend',onTransitionEnd);_this4.container.dispatchEvent(_this4._spEndEvt)})}},{key:'_loadView',value:function _loadView(url){var _this5=this;this._view=new DocumentFragment;var xhr=new XMLHttpRequest;xhr.onload=function(evt){var newDoc=evt.target.response;var newView=newDoc.querySelector('[sp-container]');if(!newView){console.error('The View loaded or not exists or not\n          contain sp-container attribute');return}newView.childNodes.forEach(function(node){_this5._view.appendChild(node)});_this5.container.innerHTML='';_this5.container.appendChild(_this5._view)};xhr.responseType='document';xhr.open('GET',url);xhr.send()}}]);return SoulPatch}();new SoulPatch;
